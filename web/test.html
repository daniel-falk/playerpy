<!DOCTYPE html>

<meta charset="utf-8" />

<title>WebSocket Test</title>

<style>
  * {
    box-sizing: border-box;
  }

  /* Create two equal columns that floats next to each other */
  .column {
    float: left;
    width: 50%;
    padding: 1%;
  }

  /* Clear floats after the columns */
  .row:after {
    content: "";
    display: table;
    clear: both;
  }


  #image {
    max-height: 100%;
    max-width: 48%;
    position: absolute;
    border: 1px solid black;

  }
</style>


<script language="javascript" type="text/javascript">

  //add event listener for page load
  window.addEventListener("load", init, false);

  //add event listener for key press
  document.addEventListener('keyup', (e) => {
    if (e.code === "ArrowLeft") {
      console.log("left")
      doSend("ARROW_LEFT")
    }
    else if (e.code === "ArrowRight") {
      doSend("ARROW_RIGHT")
    }

  });

  //Funtion to initiailize html elements 
  function init() {
    document.myform.url.value = "ws://localhost:8000/"
    document.myform.inputtext.value = "Hello World!"
    document.myform.disconnectButton.disabled = true;
  }

  //Function to make connection to Web-Socket 
  function doConnect() {
    websocket = new WebSocket(document.myform.url.value);
    websocket.onopen = function (evt) { onOpen(evt) };
    websocket.onclose = function (evt) { onClose(evt) };
    websocket.onmessage = function (evt) { onMessage(evt) };
    websocket.onerror = function (evt) { onError(evt) };
  }


  //Function called when connection established with Web-Socket successfully
  function onOpen(evt) {
    writeToScreen("connected\n");
    document.myform.connectButton.disabled = true;
    document.myform.disconnectButton.disabled = false;
  }


  //Function called when connection is disconnected with Web-Socket successfully
  function onClose(evt) {
    writeToScreen("disconnected\n");
    document.myform.connectButton.disabled = false;
    document.myform.disconnectButton.disabled = true;
  }

  //Function called when Web-Socket send response successfully
  function onMessage(evt) {
    writeToScreen("response: IMG=" + evt.data + '\n');
    document.myform.image.src = evt.data;
  }

  //Function called when Web-Socket sends ERROR message successfully
  function onError(evt) {
    writeToScreen('error: ' + evt.data + '\n');
    websocket.close();
    document.myform.connectButton.disabled = false;
    document.myform.disconnectButton.disabled = true;

  }

  //Function called when send request to Web-Socket
  function doSend(message) {
    writeToScreen("sent: " + message + '\n');
    websocket.send(message);
  }

  //Function called to display message on screen
  function writeToScreen(message) {
    document.myform.outputtext.value += message
    document.myform.outputtext.scrollTop = document.myform.outputtext.scrollHeight;
  }


  //Wrapper function for doSend()
  function sendText() {
    doSend(document.myform.inputtext.value);
  }

  //Function called to clear output text
  function clearText() {
    document.myform.outputtext.value = "";
  }

  //Function called to disconnect with Web-Sockets
  function doDisconnect() {
    websocket.close();
  }

  //Function to find image position on page
  function findImagePosition(img) {
    if (typeof (img.offsetParent) != "undefined") {
      for (var x = 0, y = 0; img; img = img.offsetParent) {
        x += img.offsetLeft;
        y += img.offsetTop;
      }
      return [x, y];
    }
    else {
      return [img.x, img.y];
    }
  }

  //Function to get normalize coordinates of image
  function GetImageCoordinates(evt) {
    var x = 0;
    var y = 0;
    var imgPos;
    imgPos = findImagePosition(img);
    if (!evt) var evt = window.event;
    if (evt.pageX || evt.pageY) {
      x = evt.pageX;
      y = evt.pageY;
    }
    else if (evt.clientX || evt.clientY) {
      x = e.clientX + document.body.scrollLeft
        + document.documentElement.scrollLeft;
      y = e.clientY + document.body.scrollTop
        + document.documentElement.scrollTop;
    }

    x -= imgPos[0];
    if (x < 0) {
      x = 0;
    }
    else if (x > img.width) {
      x = img.width
    }
    x /= img.width;

    y -= imgPos[1]
    if (y < 0) {
      y = 0;
    }
    else if (y > img.height) {
      y = img.height
    }
    y /= img.height;
    doSend("COORDINATES(x,y)=(" + x + "," + y+")")
  }

</script>


<div id="output"></div>
<form name="myform">
  <div class="row">
    <div class="column">
      <img id="image" name="image" class="image" alt="">
    </div>
    <div class="column">
      <textarea name="outputtext" rows="20" cols="50"></textarea>
      <textarea name="inputtext" cols="50"></textarea>
      <textarea name="url" cols="50"></textarea>
      <br>
      <input type="button" name=sendButton value="Send" onClick="sendText();">
      <input type="button" name=clearButton value="Clear" onClick="clearText();">
      <input type="button" name=disconnectButton value="Disconnect" onClick="doDisconnect();">
      <input type="button" name=connectButton value="Connect" onClick="doConnect();">
      </p>
    </div>
  </div>
</form>
<script>
  //Getting reference of image
  var img = document.getElementById("image");
  //Attaching mouse event to image
  img.onmousedown = GetImageCoordinates;
</script>

</html>